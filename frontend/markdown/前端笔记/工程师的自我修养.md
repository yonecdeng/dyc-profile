# 工程思维

## 代码

### 什么是代码

写代码将“现实世界中的问题”转化为“数字世界中的模型”。程序是数字世界对现实世界的一种映照，涉及对现实世界的抽象和建模。

 

### 好代码的特性

鲁棒（Solid and Robust）代码不仅要被正确执行，我们还要考虑对各种错误情况的处理，比如各种系统调用和函数调用的异常情况。对很多产品级的程序来说，异常和错误处理的逻辑占了很大比例。

![image-20230925192732348](https://picbed-1306720359.cos.ap-guangzhou.myqcloud.com/upic/2023-09-25-19-27-image-20230925192732348.png)

Don’t make me think（别让我思考）。这是一本书的名字，这本书是讲交互设计的。在代码的可读性方面，“别让我思考”也是软件工程师应该追求的目标。除少数算法逻辑需要非常复杂的代码外，对于大部分的业务和系统代码来说，这是可以实现的目标。代码更多的是写给别人（而不是自己）看的。写出更容易让人读懂的代码。<mark>先写注释，再写代码。</mark>





### 坏代码的特性

下面给出一些关于“坏代码”的简单判断方法，大家可以在实践中尝试使用。（1）花5分钟都不能看懂的代码。如果一段代码在5分钟内无法让我看懂，这个代码很可能写的有问题。大部分代码都可以把逻辑抽象和梳理得足够清楚。“清晰简单”是问题理解是否清楚的重要判断标准。（2）需要思考才能看懂的代码。2.7.5节介绍了好的代码可以做到“Don’t make me think”。需要很多思考才能看懂的代码，很可能在逻辑方面还有可以优化之处。（3）需要来回翻屏才能看懂的代码。超长的函数是代码出现问题的重要原因（见2.7.4节中的相关说明）。好的代码，往往在一屏内就是一个完整的逻辑。在代码评审中，要尽早对这样超长的函数进行处理。（4）没有空行/注释的代码。在函数内不会分段，在程序中不通过注释来提高可读性，这些都是影响代码可读性的严重问题。



### 如何看代码

第一步：看清代码全貌。要搞清楚代码中模块划分的逻辑，明确模块间的关系。

第二步：查看模块。要看清各模块内部的逻辑，搞清楚模块内的关键数据、关键的类和函数。注意，对于类和函数，在这一步只需要看清楚功能和接口定义就可以了，其目的是对各模块的全貌有一个基本印象。

第三步：查看类和函数内部的逻辑。在这一步要关注逻辑的正确性、实现的合理性、段落划分的合理性、命名的合理性等。



## 质量保障

客户绝不会容忍低质量的产品。质量必须被量化，并建立可落地实施的机制。





## 系统设计

代码的艺术 来源于 顶层设计。

高质量的软件是设计出来的，而不是写出来或测试出来的。因此，要提高软件质量，首先要提升软件的设计能力。

编码前做好需求分析和系统设计，在研发的早期少欠技术债。 

项目管理　>　文档 >　代码。对于这个排序，可以做如下解读。（1）没有好的管理，有再好的技术也没有用。（2）好的代码，首先来自好的设计。（3）需求分析先于系统设计。  （不可能要求产品经理把所有细节都写在交流文档中，很多细节的决定权实际上在软件工程师手中。软件工程师对于产品需求的理解，会影响这些细节实现的质量。）

对于一个系统来说，仅有“产品需求”是不够的，还需要分析“系统需求”。例如，对于一个“春晚抽红包”的产品，产品经理会考虑游戏规则、交互逻辑等，但是仅有这些信息是不够的，还需要考虑系统容量、容错能力等需求。后者肯定是产品经理想不到的，而对于系统设计来说，这些是非常重要的输入信息，需要由软件工程师给出。



### 什么是系统设计

系统设计是定义系统的架构、模块、接口和数据 以满足特定需求的过程。



### 如何做系统设计

#### 参考资料

感兴趣的读者可以阅读Google关于系统设计的三大经典论文：[GFS](https://static.googleusercontent.com/media/research.google.com/en//archive/gfs-sosp2003.pdf)、[Big Table](https://static.googleusercontent.com/media/research.google.com/en//archive/bigtable-osdi06.pdf)、[Map Reduce](https://static.googleusercontent.com/media/research.google.com/en//archive/mapreduce-osdi04.pdf)。



#### 系统设计应包括

如果要对系统的实现提出一个建议，一般需要描述：（1）出发点（或目的）。（2）实现的手段。（3）工作量的预估。（4）收益的预估。工作量和收益的预估是经常被遗漏的。缺少这两部分，将难以对ROI（Return On Investment，投资回报率）做出判断。

系统的设计在描述一个系统的设计时，一般需要描述：（1）系统的功能。（2）系统的组成。（3）系统的行为。4. 程序的设计在描述一个程序的设计时，一般需要描述：（1）程序的架构。（2）程序中包含的数据。（3）程序的模块划分。（4）程序模块间的调用关系。（5）程序模块的关键函数接口。





#### 好系统是迭代出来的

任何一个系统都不是一次就能设计出来和实现的，而是要经过反复迭代的。

在系统开发中，数据的收集和分析对于系统的迭代同样非常重要。如果没有足够的数据收集信息，系统等于没有上线。



#### 没有完美的系统

没有完美的系统，要在很多指标间做权衡

#### 不要过而不及

别人需要A，你却给出了A+B，超出了需求，给使用者增加了负担



#### 模块间的关系要简单且清晰

在系统中，各子系统/模块之间的关系应该简单而清晰。对于每个子系统，应该通过明确的对外接口来访问。很多人都感到软件很复杂，而软件的这种复杂性，在很大程度上来自软件中各子系统、各模块之间的耦合关系。

全局变量的可怕之处在于：在你没有察觉的情况下，在某个子系统中开放了一个行为不确定的对外接口，从而使得子系统的对外关系变得不清晰。如果一个软件中存在很多全局变量，这个软件中子系统间的关系就会变得非常混乱。



#### 基于模型思考

在系统设计中，软件工程师思考的重点是概念、模型、数据结构和算法，大家应该（也完全可以）脱离代码实现的细节，比如，使用的编程语言、具体的函数实现细节等，而基于模型思考的能力是软件工程师需具备的重要能力之一。很多软件工程师在系统的认识方面很难脱离对代码细节的关注。例如，要求对某个程序的实现进行分析，一名软件工程师给出的回答是：“这个程序从main函数开始运行，main函数调用A函数，A函数调用B函数、C函数，B函数调用D函数……”另一名软件工程师给出的回答是：“这个程序是用来处理HTTP请求的，使用了多线程的机制，在程序中包含了一个转发路由表……”从以上两个回答中可以明显地看到，两名软件工程师所“看到”的程序是完全不同的，第一名看到的是代码的细节，第二名看到的是系统中所包含的概念和模型。



#### 尽量使最外层的接口一辈子不用改

希望大家能够记住一句话“外交无小事”。对于内部实现，想要优化和修改是非常容易的，而对于外部关系，在确定后是非常难以修改的。接口变了，别人又要重新适应新接口徒增成本。

对外接口形态包括：（1）模块对外的函数接口。（2）平台对外的API（Application Programming Interface，应用程序接口），可能是Web API，也可能是RPC（Remote Procedure Call，远程过程调用）接口。（3）系统间的通信协议。比如，基于Protocol Buffer定义的协议，或者私有二进制协议。（4）系统间存在依赖的数据。比如，一个系统给另外一个系统提供的词表。











### 如何写系统设计文档

#### 留下 设计思路

仅仅在系统设计中留下最后的结果是不够的，如何推导出这个结果，其“过程”也同样重要。当前的系统设计并不是终点，未来也会有优化或重构。对于未来从事这些工作的同事来说，系统设计中所留下的“设计思路”是非常有价值的。我们有时也会看到很多系统在重构后，并没有比以前的更好，甚至在很多地方重蹈了之前的错误，这和系统设计文档中“设计思路”的缺失有很大关系。



#### 区分不同类型的设计文档

原因基于以下几点。 （1）便于读者阅读。每个文档都有特定的读者，比较典型的是“接口定义文档”，这个文档是提供给系统的外部使用者的。外部使用者并不需要了解系统的内部设计。 （2）便于编写文档的人进行修改和维护。进行切分文档后，在做修改维护时冲突的可能性会大大降低。





#### 写系统设计的不同视角

（1）静。首先，从静止的角度，描述系统如何组成，以及系统的功能在这些组成部分之间是如何划分的。这就是系统的“结构”。一般要描述的是：系统包含哪些子系统，每个子系统有什么功能。在做这些描述时，应感觉自己是一名导游，带着游客在系统的各子系统间参观。

（2）动。然后，从动态的角度，描述各子系统之间是如何联动的，它们是如何相互配合完成系统预定的任务或流程的。这就是系统的“行为”。在做这个描述时，应感觉自己是一名电影导演，将系统的各种运行情况通过一个个短片展现出来。

（3）细。最后，在以上两种描述的基础上，从不同的角度，更详细地刻画出系统的细节和全貌。这就是“更多的视图”。经过静、动、细三方面的描述，我们可以在脑海中“清楚地看到”一个系统。





### 需求分析和系统设计的区别

（1）需求分析：定义系统/软件的黑盒的行为，它是从外部（External）看到的，在说明“是什么”（What）。

（2）系统设计：设计系统/软件的白盒的机制，它是从内部（Internal）看到的，要说明“怎么做”（How）和“为什么”（Why）。





### 项目文档

<mark>没有文档的设计不是设计</mark>。不会写文档，就不会做设计，不会写文档的人更无法成为高阶软件工程师。

#### 研发文档和用户文档

项目文档可以分为研发文档和用户文档。用户文档包括产品白皮书、产品使用说明、产品操作指南等。

研发文档包括（以下几类文档中的内容都是很难通过阅读代码来获得的。）：

- 需求分析：要写清用户/客户的需求来源，分析哪些需求是重点，并说明多个需求点之间的取舍过程。

- 系统设计

- 接口设计：要写明接口的功能描述、传入参数和返回值。

- 关键性的算法设计文档：要写明算法设计的思路、算法中的关键点。
- 系统总体架构文档：要从全局的角度说明系统的组成和行为，帮助阅读者快速了解系统的总体思路

#### 项目文档内容

在项目文档内容的选择上，可以遵循以下原则：凡是不那么“显而易见”的地方，最好都留下文档。在是否“显而易见”的判断方面，应站在阅读者的角度，要考虑当前项目成员的一般水平和知识背景。



在项目文档中不仅要留下设计结果（What），还要留下思考过程（Why）。在项目文档中留下这些决策的依据，对后续工作会有巨大帮助。使之有效继承前一代系统研发中所获得的各种经验。对于一个好的研发项目来说，留下的不仅仅是一个可以运行的系统，还应该包含各种思考和探索的经验。

 



#### 写文档的小技巧

##### 内容结构

文档的内容结构是通过分析得到的，而不是靠套用模板得到的。



##### 使用术语

要使用业界通用的概念，而不要随意编造出新的概念；要使用业界通用的表述方式，而不要使用自己创造的表述方式。

 



##### 文档版本

（1）封面。一个正规的项目文档要包含封面，封面上要说明文档的所属项目、编号、文档的版本号。这些信息有助于未来其他文档对这个文档的引用。（2）版本历史说明。在文档的头部，要有对文档历史的说明，包括修改人、修改日期、修改说明。文档的历史说明有助于阅读者了解文档的修改过程，也便于追溯文档编写的上下文和背景。（3）编写说明。编写说明中可以包含文档编写的背景和目的，也可以包含文档内容的概要说明。编写说明的目的类似于论文摘要，可以让阅读者很快了解文档的内容。（4）文档版式。我一般推荐文档的正文使用宋体、五号字、单倍行距。字体太大或行距太大，会使一页内所展示的信息量太少，从而影响阅读效率。

 

##### 切分问题

在切分问题时，首先注意要选择合适的角度。在选择好角度后，在文档中描述子问题之前，要对切分问题的角度进行说明，以便阅读者能更好地理解。

在描述子问题时，要注意以下三点。（1）是否是一个独立的问题。要判断问题的切分是否准确，在切分不好的情况下，有时会把一个子问题分为多个，有时也会把多个子问题判断为一个。（2）是否是一个重要的问题。对于重要的问题，要多使用一些篇幅来深入描述。很多文档写得不好，是由于重要的问题写得不深入，不重要的问题反而花了不少篇幅。（3）子问题间的联系。多个子问题间一定是存在一些联系的，在文档中要把它们之间的联系说明清楚。

 

##### 文档中应包含"提出问题"

分析和解决一个问题的时候，一般的模式是：（1）提出问题。（2）分析问题。（3）解决问题。一些人在写文档时，经常忽略“提出问题”和“分析问题”这两部分内容，而只涉及“解决问题”，这样的文档很容易让阅读者“迷茫”。

 

##### 图片的应用

每张图片只能展示1～2个主要问题，也只能说明一个层次上的问题。如果图片中同时有太多的关注点，很容易让阅读者在阅读时“失焦”。

对于一张图，要在正文中给出辅助性说明。虽然图片中已经呈现了各种信息，但是恰当的说明可以引导阅读者更好地获取和理解图片中的信息。阅读者的视线会随着文字的引导而完成对图片的浏览。

在项目文档中，经常使用的图包括：流程图、架构图、时序图等等。（将架构图和流程图混在一起绘制，这是项目文档编写者常犯的一个错误。）

在文档的配图方面还有一个常见的问题，那就是“没有图题”。

 

#### 项目文档存放

项目文档应围绕“项目”来进行存档。项目才是研发组织的主线，围绕个人或团队来建立项目存档都是不好的做法。2. 对文档建立版本控制机制对于项目文档，也要和代码一样建立版本控制机制。对于文档的修改、提交要能够做到很好的追踪。3. 建立文档索引在一个项目内，应针对项目文档建立一个文档索引。索引中的主要内容包括：

（1）文档的题目。（2）文档的编号。（3）文档的作者、修改人。（4）文档的编写/修改时间。（5）文档的简要说明。



### 软件的架构

（1）区分“数据类的模块”和“过程类的模块”。（2）以数据为中心，首先列出数据类的模块。

 

### 其他实现细节

Explicit is better than implicit（显式比隐式好）。







## 团队

### 人数

软件研发项目中沟通成本随着人数增长而呈指数型增长的规律，小规模优秀工程师团队的研发效率要远高于大规模普通工程师的团队。



### 代码评审

#### 代码评审的重要意义

（1）代码评审有助于提升代码质量。

（2）代码评审有助于知识的传递。

- 每个人不应该仅仅知道代码是怎么修改的，更应该知道设计决策背后的原因。代码评审给了开发者一个解释他们设计的机会。
- 在辅导他人编码方面，代码评审是最好的方法。

![image-20230926111330852](https://picbed-1306720359.cos.ap-guangzhou.myqcloud.com/upic/2023-09-26-11-13-image-20230926111330852.png)







#### 如何做好代码评审

第一，评审人对被评审的代码逻辑应做到“完全看懂”。

第二，评审人对什么是好的代码应该有正确的认识。

第三，在代码评审中要以“提升代码质量”为最终目标，代码编写者和代码评审人要共同努力。因此，代码评审不是单方的事情，而是需要双方的紧密沟通和配合。

第四，代码评审花费的时间经常和编写代码一样多，甚至有时比编写代码的时间还要多。代码评审人也要对代码质量承担起责任，如果代码出现Bug，评审人也要承担相当大的责任。

好的代码评审人，不仅是指出代码表面的问题，还会查看系统需求分析的质量、接口/函数定义的合理性、模块划分的合理性和系统关键机制的合理性。好的代码评审人，会从一个独立的视角把系统的需求、设计、实现都综合思考一遍，他对系统的理解不会低于代码编写人。要成为好的代码评审人，也需要提升自己写代码的水平。

#### 如何代码评审or如何看代码

第一步：看清代码全貌。要搞清楚代码中模块划分的逻辑，明确模块间的关系。

第二步：查看模块。要看清各模块内部的逻辑，搞清楚模块内的关键数据、关键的类和函数。注意，对于类和函数，在这一步只需要看清楚功能和接口定义就可以了，其目的是对各模块的全貌有一个基本印象。

第三步：查看类和函数内部的逻辑。在这一步要关注逻辑的正确性、实现的合理性、段落划分的合理性、命名的合理性等。





## 工程能力

### 总览

工程能力分解为公司能力素质、团队能力素质和个人能力素质三类

![image-20230925174723290](https://picbed-1306720359.cos.ap-guangzhou.myqcloud.com/upic/2023-09-25-17-47-image-20230925174723290.png)



### 个人能力素质

以下这些基础的建立至少需要5～8年之功。软件工程师不等于“码农”，软件工程师不能只知道怎么编写代码，还需要具备非常综合的能力。

#### 软件工程师应具备的综合素质

（1）专业知识。软件工程师需要掌握的专业知识包括数据结构、算法、编码方法等，还包括系统结构、操作系统、计算机网络、分布式系统等。基础的软件编写方法、软件工程方法、编程思想等。

（2）产品。软件工程师还需要具有产品方面的思维，要对业务有深刻的理解。为了提供良好的用户体验，软件工程师需要学习交互设计，这是一个非常专业的学科方向；还需要学习产品数据统计，会基于数据来优化产品；更需要学习产品/业务运营，这对很多运营型的产品（如社区）来说，非常重要。

（3）项目管理。做软件项目不是一个人的工作，要做好软件项目需要懂得管理。

（4）研究和创新。有一些项目具有很强的研究和创新属性，这要求软件工程师要具备“研究”的能力。很多公司将软件工程师称为RD，RD的意思是Research（研究）和Development（开发）。对于不具备研究能力的软件工程师，他们只能被称为Developer（开发者）。分析问题和解决问题的能力。

（5）基本思考能力和沟通能力，包括：逻辑思维能力、归纳总结能力和表达能力等。



#### 如何做好研究

要相信“没有任何事情是完美的”。在工程研究中常常是在做取舍（Tradeoff），通过牺牲我们不重视的方面，来获得我们重视的方面的提高。不要试图去寻找一种完美的方法，这种寻找常常会无果而终。反过来，如果一个人宣称他所设计的方法在任何方面都达到最优，也可以大概率判断出这个说法很可能存在问题。

在不同的场景下做取舍有很多不同的方式，这就是研究的机会。空间和时间、延迟和吞吐、性能和公平、读取性能和变更性能，这些因素之间都存在着取舍的关系。具体如何取舍，要基于问题的假设和场景来判断

 

## 项目管理

### 项目管理的方法

（1）规划和启动：责任明确，周密策划，实事求是，质量第一。（2）执行和监控：沟通协作，严密跟踪，控制风险，打出节奏。（3）总结和回顾：做好总结，不断提高。





### 项目排期

在项目估算和排期的时候，把代码评审的时间考虑进去。 * 1.5



# 成为优秀软件工程师

## 心态

不要忘记我们为什么出发。我们的目标是改变世界/格物致知，而不是学习编程或者炫耀技术。最开始我认为，写代码的目标是“改变世界”，但是后来我改变了想法，将目标转变为“格物致知”。其实，我们工作和生活的更主要的目的是增加对这个世界的理解和认识。如果写了多年代码，但仍然对写代码的“道”没有了解，那么时间和生命就浪费了。



## 做法

 优秀软件工程师的修炼方法总结为以下三句话。（1）学习—思考—实践。（2）知识—方法—精神。（3）基础乃治学之根本。

相对于“知识”，“方法”这个词总是让很多人感到很“虚”。但是这个“虚”（的方法）可能比那个“实”（的知识）更有价值。最深刻的方法其实是不可言传的，正如《老子》中的一句话：道可道，非常道。（如果“道”可以说出来，就不是永恒的“道”了。）对于软件工程师来说，分析问题、解决问题的能力才是最重要的。其实，这就是“研究”的能力。关于“研究”，20多年前加州理工学院的Steven Low老师曾在给我的一封邮件中给出过一个很好的定义：To Identify the Fundamental Problem, and Solve it.（去识别、定义那些最重要的问题，并解决。）